# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Fuera de Contexto** - E-commerce platform for custom clothing (buzos, gorras, camperas, remeras, accesorios) built with Next.js 16 App Router, React 19, TypeScript, and Tailwind CSS 4.

## Development Commands

```bash
# Development
npm run dev          # Start dev server at localhost:3000

# Build
npm run build        # Production build
npm start            # Start production server

# Linting
npm run lint         # Run ESLint on codebase
```

## Tech Stack Decisions

### Estado Global
- **Actual (mantener):** Cart y Wishlist usan Context API
- **Nuevos estados:** Usar **Zustand** para cualquier estado global adicional
- NO crear nuevos Context APIs, migrar a Zustand cuando sea necesario

### Formularios
- **Stack obligatorio:** `react-hook-form` + `zod`
- Usar en todos los formularios (filtros, búsqueda, edición, etc.)
- Validación con schemas de Zod

### API Layer
- **Usar:** Route Handlers (`app/api/*/route.ts`)
- **NO usar:** Server Actions
- Todas las mutaciones y queries van por API routes explícitas

### UI Patterns
- **NO usar:** Modales para crear/editar recursos
- **Usar:** Páginas dedicadas con URLs propias
- Ejemplo: `/admin/productos/nuevo` en lugar de modal

### Autenticación
- **Sistema:** NextAuth.js v5 (beta) con Credentials Provider
- **Session Strategy:** JWT (7 días de expiración)
- **Providers:** Email/Password (OAuth puede agregarse después)
- **Route Protection:** Middleware en `src/middleware.ts`
- **API Protection:** `requireAdmin()` y `requireAuth()` desde `src/lib/auth/auth-utils.ts`
- **Password Security:** Bcrypt con 12 salt rounds
- **Email Service:** Resend (para verificación y reset de contraseña)
- **Estado:** Parcialmente implementado (Phases 1-3 completadas)

### Data Layer
- **Base de datos:** PostgreSQL (Railway) + Prisma ORM
- **Productos:** Migrados a base de datos (23 productos)
- **API Routes:** `/api/products` para Client Components
- **Server Components:** Acceso directo a Prisma cuando sea posible

## Architecture

### App Router Structure (Next.js 16)

The application uses Next.js App Router with the following key routes:
- `/` - Homepage with hero, categories, flash sales, featured products
- `/catalogo` - Product catalog with filters and sorting
- `/producto/[slug]` - Dynamic product detail pages
- `/carrito` - Shopping cart
- `/checkout` - Checkout flow
- `/mi-cuenta` - User account pages
- `/(auth)` - Authentication route group

### State Management

**Cart Context** (`src/context/cart-context.tsx`):
- Global cart state with localStorage persistence
- Cart items identified by unique combination: `productId-size-colorName`
- Methods: `addItem`, `removeItem`, `updateQuantity`, `clearCart`
- Tracks `totalItems` and `subtotal`

**Wishlist Context** (`src/context/wishlist-context.tsx`):
- Wishlist with localStorage persistence
- Methods: `addItem`, `removeItem`, `isInWishlist`, `toggle`

Both contexts use client components ("use client") and provide data to the entire app via providers in the root layout.

### Component Organization

```
src/components/
├── home/        # Homepage sections (hero, categories, flash-sale, etc.)
├── layout/      # Navigation, footer, mobile-nav, top-banner
├── product/     # Product detail components (gallery, selectors, tabs)
├── catalog/     # Catalog-specific (filters, sort-dropdown)
├── cart/        # Cart-related components
├── checkout/    # Checkout flow components
├── account/     # User account components
├── shared/      # Reusable components (ProductCard, QuantitySelector, etc.)
└── ui/          # shadcn/ui base components (Button, Card, Badge, etc.)
```

**Important**: Components in `ui/` are generated by shadcn/ui. Use the shadcn CLI to add/modify them rather than manual edits when possible.

### Type System

Core types defined in `src/types/index.ts`:

**Product**:
- Includes: id, slug, name, description, price, originalPrice, discount, images[], category, sizes[], colors[], rating, reviewCount, soldCount, stock
- Flags: isNew, isFeatured, isFlashSale

**CartItem**:
- Contains: product, quantity, selectedSize, selectedColor
- Cart items are uniquely identified by the combination of product ID + size + color

**Categories**: `buzos | gorras | camperas | remeras | accesorios`

**Sizes**: `XS | S | M | L | XL | XXL | Unico`

### Data Layer

Static data is stored in `src/data/`:
- `products.ts` - Product catalog
- `categories.ts` - Category definitions
- `banners.ts` - Promotional banners

This is for development/demo purposes. In production, replace with API calls or database queries.

### Styling

- **Tailwind CSS 4** with PostCSS
- **shadcn/ui** components styled with "new-york" theme
- CSS variables for theming in `src/app/globals.css`
- Dark/light mode support via `next-themes`
- Path aliases: `@/*` maps to `src/*`

### Configuration

- **components.json**: shadcn/ui config with aliases for components, utils, hooks
- **next.config.ts**: Configured to allow images from `placehold.co`
- **tsconfig.json**: Path alias `@/*` → `src/*`, strict mode enabled

### Key Patterns

1. **Cart Item Identity**: When working with cart operations, remember items are uniquely identified by `productId-size-colorName` combination, not just product ID.

2. **Client Components**: Cart and Wishlist contexts require "use client" directive. Components using these contexts also need "use client".

3. **localStorage Keys**:
   - Cart: `fdc-cart`
   - Wishlist: `fdc-wishlist`

4. **Image Optimization**: Use Next.js `<Image>` component with proper width/height. Remote patterns configured for placehold.co.

5. **Responsive Design**: Mobile-first approach. Use `useMobile` hook from `src/hooks/use-mobile.ts` for responsive behavior in components.

## Adding New Features

**Adding UI Components**:
Use shadcn CLI to add components to maintain consistency:
```bash
npx shadcn@latest add [component-name]
```

**Adding Product Features**:
1. Update type definitions in `src/types/index.ts`
2. Update product data in `src/data/products.ts`
3. Update relevant UI components

**Cart/Wishlist Modifications**:
When modifying cart logic, ensure the unique key pattern (`productId-size-colorName`) is maintained across all operations to prevent duplicate entries or incorrect updates.

## Admin Panel

### Structure
- **Location:** `/admin/*`
- **Routes:**
  - `/admin` - Dashboard with statistics
  - `/admin/productos` - Products management (full CRUD)
  - `/admin/pedidos` - Orders management (read + status updates)
  - `/admin/usuarios` - Users management (read + status/role updates)
- **Auth:** NextAuth.js con middleware protection y session checks
- **Patterns:** Server Components for data fetching, Client Components for interactions

### Architecture Patterns
- **Server Components:** Use for list pages that fetch data from database
- **Client Components:** Use for forms, filters, and interactive elements
- **Database Layer:** Functions in `src/lib/db/` for all queries
- **API Routes:** All mutations go through `/api/*` endpoints
- **Validation:** Zod schemas in `src/lib/validations/admin.ts` used in both frontend and backend
- **State:** Zustand stores in `src/store/admin-store.ts` for filters (synced with URL)

### Key Files
- `src/lib/db/products.ts` - Product queries (CRUD operations)
- `src/lib/db/orders.ts` - Order queries (list, detail, status updates)
- `src/lib/db/users.ts` - User queries (list, detail, status/role updates, **NEVER returns password**)
- `src/lib/validations/admin.ts` - Zod validation schemas
- `src/store/admin-store.ts` - Zustand stores for filters
- `src/lib/auth/auth-utils.ts` - NextAuth helper functions (requireAdmin, requireAuth, getCurrentSession)
- `src/lib/auth/auth-config.ts` - NextAuth configuration (providers, callbacks, JWT)
- `src/lib/auth/password-utils.ts` - Password hashing and validation utilities

### Security Notes
- **Users API:** NEVER expose password field (excluded in `transformUser` function)
- **Admin Routes:** Protected with NextAuth middleware (`src/middleware.ts`) and `requireAdmin()` checks
- **API Routes:** All admin mutations require `await requireAdmin()` call
- **Password Security:** Bcrypt hashing with 12 salt rounds, strength validation enforced
- **Session:** JWT strategy with 7-day expiration, includes role and status in token
- **Validation:** Always validate in both frontend (react-hook-form + Zod) and backend (API routes + Zod)
