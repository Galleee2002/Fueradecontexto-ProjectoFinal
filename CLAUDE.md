# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Fuera de Contexto** - E-commerce platform for custom clothing (buzos, gorras, camperas, remeras, accesorios) built with Next.js 16 App Router, React 19, TypeScript, and Tailwind CSS 4.

## Development Commands

```bash
# Development
npm run dev          # Start dev server at localhost:3000

# Build
npm run build        # Production build
npm start            # Start production server

# Linting
npm run lint         # Run ESLint on codebase
```

## Tech Stack Decisions

### Estado Global
- **Actual (mantener):** Cart y Wishlist usan Context API
- **Nuevos estados:** Usar **Zustand** para cualquier estado global adicional
- NO crear nuevos Context APIs, migrar a Zustand cuando sea necesario

### Formularios
- **Stack obligatorio:** `react-hook-form` + `zod`
- Usar en todos los formularios (filtros, búsqueda, edición, etc.)
- Validación con schemas de Zod

### API Layer
- **Usar:** Route Handlers (`app/api/*/route.ts`)
- **NO usar:** Server Actions
- Todas las mutaciones y queries van por API routes explícitas

### UI Patterns
- **NO usar:** Modales para crear/editar recursos
- **Usar:** Páginas dedicadas con URLs propias
- Ejemplo: `/admin/productos/nuevo` en lugar de modal

### Autenticación
- **Sistema:** NextAuth.js v5 (beta.30) con Credentials Provider
- **Session Strategy:** JWT (7 días de expiración)
- **Providers:** Email/Password (OAuth puede agregarse después)
- **Route Protection:** Middleware en `src/middleware.ts`
- **API Protection:** `requireAdmin()` y `requireAuth()` desde `src/lib/auth/auth-utils.ts`
- **Password Security:** Bcrypt con 12 salt rounds
- **Email Service:** Resend (integrado y funcional)
  - Servicio: `src/lib/email/email-service.ts`
  - Funciones: `sendVerificationEmail()`, `sendPasswordResetEmail()`, `sendWelcomeEmail()`
- **Estado:** 100% completado (Phases 1-6)
- **UI Funcional:** Páginas de Login, Registro, Error, Verificación y Reseteo de contraseña.
- **Navbar Dinámica:** Menú de usuario con logout implementado

### Data Layer
- **Base de datos:** PostgreSQL (Railway) + Prisma ORM
- **Productos:** Migrados a base de datos (23 productos)
- **API Routes:** `/api/products` para Client Components
- **Server Components:** Acceso directo a Prisma cuando sea posible

## Architecture

### App Router Structure (Next.js 16)

The application uses Next.js App Router with the following key routes:
- `/` - Homepage with hero, categories, flash sales, featured products
- `/catalogo` - Product catalog with filters and sorting
- `/producto/[slug]` - Dynamic product detail pages
- `/carrito` - Shopping cart
- `/checkout` - Checkout flow
- `/mi-cuenta` - User account pages (protected)
- `/(auth)` - Authentication route group:
  - `/auth/login` - Login page
  - `/auth/registro` - Registration page
  - `/auth/error` - Authentication error page
- `/admin` - Admin panel (protected, admin-only)

### State Management

**Cart Context** (`src/context/cart-context.tsx`):
- Global cart state with localStorage persistence
- Cart items identified by unique combination: `productId-size-colorName`
- Methods: `addItem`, `removeItem`, `updateQuantity`, `clearCart`
- Tracks `totalItems` and `subtotal`

**Wishlist Context** (`src/context/wishlist-context.tsx`):
- Wishlist with localStorage persistence
- Methods: `addItem`, `removeItem`, `isInWishlist`, `toggle`

Both contexts use client components ("use client") and provide data to the entire app via providers in the root layout.

### Component Organization

```
src/components/
├── home/        # Homepage sections (hero, categories, flash-sale, etc.)
├── layout/      # Navigation, footer, mobile-nav, top-banner
├── product/     # Product detail components (gallery, selectors, tabs)
├── catalog/     # Catalog-specific (filters, sort-dropdown)
├── cart/        # Cart-related components
├── checkout/    # Checkout flow components
├── account/     # User account components
├── shared/      # Reusable components (ProductCard, QuantitySelector, etc.)
└── ui/          # shadcn/ui base components (Button, Card, Badge, etc.)
```

**Important**: Components in `ui/` are generated by shadcn/ui. Use the shadcn CLI to add/modify them rather than manual edits when possible.

### Type System

Core types defined in `src/types/index.ts`:

**Product**:
- Includes: id, slug, name, description, price, originalPrice, discount, images[], category, sizes[], colors[], rating, reviewCount, soldCount, stock
- Flags: isNew, isFeatured, isFlashSale

**CartItem**:
- Contains: product, quantity, selectedSize, selectedColor
- Cart items are uniquely identified by the combination of product ID + size + color

**Categories**: `buzos | gorras | camperas | remeras | accesorios`

**Sizes**: `XS | S | M | L | XL | XXL | Unico`

### Data Layer

Static data is stored in `src/data/`:
- `products.ts` - Product catalog
- `categories.ts` - Category definitions
- `banners.ts` - Promotional banners

This is for development/demo purposes. In production, replace with API calls or database queries.

### Styling

- **Tailwind CSS 4** with PostCSS
- **shadcn/ui** components styled with "new-york" theme
- CSS variables for theming in `src/app/globals.css`
- Dark/light mode support via `next-themes`
- Path aliases: `@/*` maps to `src/*`

### Configuration

- **components.json**: shadcn/ui config with aliases for components, utils, hooks
- **next.config.ts**: Configured to allow images from `placehold.co`
- **tsconfig.json**: Path alias `@/*` → `src/*`, strict mode enabled

### Key Patterns

1. **Cart Item Identity**: When working with cart operations, remember items are uniquely identified by `productId-size-colorName` combination, not just product ID.

2. **Client Components**: Cart and Wishlist contexts require "use client" directive. Components using these contexts also need "use client".

3. **localStorage Keys**:
   - Cart: `fdc-cart`
   - Wishlist: `fdc-wishlist`

4. **Image Optimization**: Use Next.js `<Image>` component with proper width/height. Remote patterns configured for placehold.co.

5. **Responsive Design**: Mobile-first approach. Use `useMobile` hook from `src/hooks/use-mobile.ts` for responsive behavior in components.

## Adding New Features

**Adding UI Components**:
Use shadcn CLI to add components to maintain consistency:
```bash
npx shadcn@latest add [component-name]
```

**Adding Product Features**:
1. Update type definitions in `src/types/index.ts`
2. Update product data in `src/data/products.ts`
3. Update relevant UI components

**Cart/Wishlist Modifications**:
When modifying cart logic, ensure the unique key pattern (`productId-size-colorName`) is maintained across all operations to prevent duplicate entries or incorrect updates.

## Admin Panel

### Structure
- **Location:** `/admin/*`
- **Routes:**
  - `/admin` - Dashboard with statistics
  - `/admin/productos` - Products management (full CRUD)
  - `/admin/pedidos` - Orders management (read + status updates)
  - `/admin/usuarios` - Users management (read + status/role updates)
- **Auth:** NextAuth.js con middleware protection y session checks
- **Patterns:** Server Components for data fetching, Client Components for interactions

### Architecture Patterns
- **Server Components:** Use for list pages that fetch data from database
- **Client Components:** Use for forms, filters, and interactive elements
- **Database Layer:** Functions in `src/lib/db/` for all queries
- **API Routes:** All mutations go through `/api/*` endpoints
- **Validation:** Zod schemas in `src/lib/validations/admin.ts` used in both frontend and backend
- **State:** Zustand stores in `src/store/admin-store.ts` for filters (synced with URL)

### Key Files
- `src/lib/db/products.ts` - Product queries (CRUD operations)
- `src/lib/db/orders.ts` - Order queries (list, detail, status updates)
- `src/lib/db/users.ts` - User queries (list, detail, status/role updates, **NEVER returns password**)
- `src/lib/validations/admin.ts` - Zod validation schemas
- `src/store/admin-store.ts` - Zustand stores for filters
- `src/auth.ts` - NextAuth v5 initialization (exports auth, signIn, signOut, handlers)
- `src/lib/auth/auth-config.ts` - NextAuth configuration (providers, callbacks, JWT) using NextAuthConfig
- `src/lib/auth/auth-utils.ts` - NextAuth helper functions (requireAdmin, requireAuth, getCurrentSession)
- `src/lib/auth/password-utils.ts` - Password hashing and validation utilities
- `src/middleware.ts` - Route protection middleware using NextAuth v5 auth()

### Security Notes
- **Users API:** NEVER expose password field (excluded in `transformUser` function)
- **Admin Routes:** Protected with NextAuth middleware (`src/middleware.ts`) and `requireAdmin()` checks
- **API Routes:** All admin mutations require `await requireAdmin()` call
- **Password Security:** Bcrypt hashing with 12 salt rounds, strength validation enforced
- **Session:** JWT strategy with 7-day expiration, includes role and status in token
- **Validation:** Always validate in both frontend (react-hook-form + Zod) and backend (API routes + Zod)

## NextAuth v5 Implementation Details

### Migration from v4 to v5
The project uses NextAuth v5 (beta.30), which has breaking changes from v4:

**Key Changes:**
- `NextAuthOptions` → `NextAuthConfig`
- `withAuth()` middleware → `auth()` function
- `getServerSession()` → `auth()` from `src/auth.ts`

**File Structure:**
```
src/
├── auth.ts                          # NextAuth v5 initialization
│   └── Exports: { auth, signIn, signOut, handlers }
├── lib/auth/
│   ├── auth-config.ts              # NextAuthConfig (providers, callbacks, session)
│   ├── auth-utils.ts               # Helper functions (requireAdmin, requireAuth)
│   └── password-utils.ts           # Bcrypt utilities
├── middleware.ts                    # Route protection using auth()
└── app/api/auth/[...nextauth]/     # API route handlers
```

**Authentication Flow:**
1. User submits credentials via `/auth/login`
2. NextAuth validates via `CredentialsProvider` in `auth-config.ts`
3. JWT token created with custom fields (userId, role, isActive, emailVerified)
4. Session exposed to client with custom user fields
5. Middleware protects routes by checking `req.auth.user.role` and `req.auth.user.isActive`

**Custom Session Fields:**
The session is extended to include:
- `user.id` - User ID from database
- `user.role` - "customer" | "admin"
- `user.isActive` - Account status
- `user.emailVerified` - Email verification status (boolean, not Date)

**Type Definitions:**
Custom types are declared in `src/types/next-auth.d.ts` to extend NextAuth's default types.

**Important Notes:**
- Use type assertions (`as any`, `as string`) when accessing custom session fields due to NextAuth v5 beta type limitations
- `emailVerified` is stored as boolean in Prisma (not Date as in default NextAuth)
- All credentials must be cast to `string` in authorize function
- Middleware uses `req.auth.user` (not `req.nextauth.token`) to access session data

## Known Issues & Fixes

### Build Errors Fixed (2026-02-03)
1. **middleware.ts**: Updated from `withAuth` to `auth()` pattern
2. **layout.tsx**: Fixed corrupted file with `...` literal
3. **Type errors**: Fixed various TypeScript issues related to NextAuth v5 types
4. **Zod schemas**: Updated `errorMap` to `message` for Zod 4.x compatibility
5. **Filter functions**: Changed to accept `Partial<FilterData>` types

### Zod 4.x Breaking Changes
When using `z.enum()`, use `message` instead of `errorMap`:
```typescript
// ❌ Old (Zod 3.x)
z.enum(["value1", "value2"], {
  errorMap: () => ({ message: "Invalid value" })
})

// ✅ New (Zod 4.x)
z.enum(["value1", "value2"], {
  message: "Invalid value"
})
```

## Mercado Pago Integration

### Overview
Complete checkout implementation using **Mercado Pago Checkout Pro** (redirect flow). Customers are redirected to Mercado Pago's hosted checkout page to complete payment securely.

### Architecture

**Checkout Flow:**
1. User fills shipping form (validated with react-hook-form + Zod)
2. User selects shipping method (Standard/Express)
3. User confirms order
4. Backend creates order and reserves stock
5. Backend creates MP preference
6. User is redirected to Mercado Pago
7. User completes payment
8. MP sends webhook notification
9. Backend updates order status
10. User sees success page + receives email

**Stock Management:**
- Stock is reserved when order is created (atomic transaction)
- Stock is restored if payment fails or is cancelled
- Stock check before order creation prevents overselling

### Key Files

**Backend:**
- `src/lib/mercadopago/client.ts` - MP SDK client (lazy initialization)
- `src/lib/mercadopago/preference.ts` - Creates payment preferences
- `src/lib/mercadopago/payment.ts` - Fetches payment info from MP API
- `src/lib/mercadopago/webhooks.ts` - Webhook validation
- `src/lib/db/stock.ts` - Stock management (reserve/restore/check)
- `src/app/api/checkout/create-order/route.ts` - Order creation endpoint
- `src/app/api/mercadopago/webhook/route.ts` - Webhook handler

**Frontend:**
- `src/components/checkout/shipping-form.tsx` - Validated shipping form
- `src/app/checkout/page.tsx` - Checkout flow orchestration
- `src/app/checkout/success/[orderId]/page.tsx` - Success page
- `src/app/checkout/failure/page.tsx` - Failure page

**Validation:**
- `src/lib/validations/checkout.ts` - Zod schemas for checkout

**Email:**
- `src/lib/email/order-confirmation.ts` - Order confirmation email template

### Environment Variables

Required for checkout to work:

```env
MERCADO_PAGO_ACCESS_TOKEN="APP_USR-xxxxx"
MERCADO_PAGO_PUBLIC_KEY="APP_USR-xxxxx"
```

### Webhook Configuration

1. Go to: https://www.mercadopago.com.ar/developers/panel/webhooks
2. Create webhook with URL: `https://your-domain.com/api/mercadopago/webhook`
3. Select events: `payment.created`, `payment.updated`
4. For local development, use ngrok: `ngrok http 3000`

### Database Schema

Order model includes MP fields:
- `mpPreferenceId` - Mercado Pago preference ID
- `mpPaymentId` - Payment ID from MP
- `mpStatus` - Payment status from MP
- `mpPaymentType` - Payment method used
- `mpMerchantOrder` - Merchant order ID
- `paidAt` - Timestamp when payment was confirmed

### Payment Status Mapping

| MP Status | Internal Status |
|-----------|----------------|
| approved | paid |
| rejected | failed |
| cancelled | failed |
| pending | pending |
| refunded | refunded |

### Security Notes

- Stock operations use Prisma transactions (atomic)
- Payment verification via MP API (not just webhook)
- Webhook always returns 200 to prevent retries
- Order validation checks user ownership
- All prices calculated server-side (never trust client)

## Current Project Status

**Last Updated:** 2026-02-03

**Completion Status:**
- ✅ Frontend UI (100%)
- ✅ Database Layer (100%)
- ✅ Admin Panel (100%)
- ✅ Authentication (100%)
  - ✅ Phase 1-6: Core auth, route protection, UI, email service, integration, and testing.
- ✅ Checkout Flow (100%)
  - ✅ Shipping form with react-hook-form + Zod validation
  - ✅ Shipping method selection (Standard/Express)
  - ✅ Order summary with dynamic shipping costs
  - ✅ Success and failure pages
- ✅ Payment Integration (100%)
  - ✅ Mercado Pago Checkout Pro integration
  - ✅ Stock management (reserve/restore)
  - ✅ Webhook handler for payment notifications
  - ✅ Order confirmation emails
  - ✅ Complete order lifecycle

**Next Steps:**
1. Configure Mercado Pago credentials in production
2. Set up webhook URL in Mercado Pago dashboard
3. Test complete checkout flow with sandbox credentials
4. Migrate Cart/Wishlist to database for authenticated users (optional enhancement)
5. Create first admin user (via seed script or manually)
